<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>幼兒園教保活動課程大綱 - 學習指標</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", Arial, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .domain-section {
      margin-bottom: 60px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .domain-title {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #333;
      border-bottom: 3px solid #8db255;
      padding-bottom: 10px;
    }
    
    .summary-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    
    .summary-table th {
      background-color: #8db255;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 18px;
      border: 1px solid #7ba044;
    }
    
    .summary-table td {
      border: 1px solid #ddd;
      padding: 15px;
      vertical-align: top;
    }

    /* 空的表格單元格顯示深灰色背景 */
    .summary-table td:empty,
    .summary-table td.empty-cell {
      background-color: #e8e8e8;
    }
    
    .summary-table .ability-cell {
      background-color: #e8f1d4;
      font-weight: bold;
      text-align: center;
      width: 150px;
      vertical-align: middle;
    }
    
    .summary-table .goal-code {
      font-weight: bold;
      color: #2c5282;
      margin-right: 8px;
    }

    .summary-cell-item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .summary-cell-item:last-child {
      margin-bottom: 0;
    }

    .goal-desc {
      line-height: 1.6;
    }

    /* 有 colspan 的單元格水平垂直置中 */
    .summary-table td[colspan] {
      text-align: center !important;
      vertical-align: middle !important;
    }

    /* 有 colspan 的內容也要置中 */
    .summary-table td[colspan] .summary-cell-item {
      justify-content: center;
    }

    /* 有 rowspan 的單元格垂直置中 */
    .summary-table td[rowspan] {
      vertical-align: middle !important;
    }

    /* 沒有 colspan 的單元格靠左對齊 */
    /* .summary-table td:not([colspan]) {
      text-align: left;
      vertical-align: top;
    } */

    /* 對角線表頭樣式 */
    .diagonal-header {
      background-image: linear-gradient(to bottom left,
        transparent 0%,
        transparent calc(50% - 0.8px),
        #7ba044 calc(50% - 0.8px),
        #7ba044 calc(50% + 0.8px),
        transparent calc(50% + 0.8px),
        transparent 100%);
      position: relative;
      padding: 20px !important;
      min-width: 150px;
      min-height: 80px;
    }

    .diagonal-header .top-right {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 16px;
      line-height: 1.3;
      text-align: right;
    }

    .diagonal-header .bottom-left {
      position: absolute;
      bottom: 10px;
      left: 15px;
      font-size: 16px;
      line-height: 1.3;
    }
    
    .detail-title {
      font-size: 22px;
      font-weight: bold;
      margin: 30px 0 15px 0;
      color: #2c5282;
    }
    
    .detail-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    
    .detail-table th {
      background-color: #4a7ba7;
      color: white;
      padding: 10px 8px;
      text-align: center;
      border: 1px solid #3a6b97;
      font-size: 15px;
    }
    
    .detail-table td {
      border: 1px solid #ddd;
      padding: 12px 10px;
      vertical-align: top;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .detail-table .goal-col {
      font-weight: bold;
      color: #2c5282;
      text-align: center;
      width: 180px;
      background-color: #f9f9f9;
      vertical-align: middle;
    }
    
    .detail-table .desc-col {
      background-color: #fafafa;
    }

    /* 空的 desc-col 顯示深灰色背景 */
    .desc-col:empty,
    .desc-col.empty-cell {
      background-color: #e8e8e8;
    }

    .detail-table .goal-code {
      font-size: 16px;
      margin-bottom: 6px;
    }

    .detail-table .goal-desc {
      font-weight: normal;
      color: #333;
      line-height: 1.6;
    }

    .indicator-cell {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .indicator-code {
      font-weight: bold;
      color: #2c5282;
    }
    
    .indicator-desc {
      color: #444;
      line-height: 1.6;
    }
    
    .age-header {
      background-color: #5a8bb7 !important;
    }
    
    .goal-group {
      background-color: #f0f0f0;
    }

    .status-message {
      text-align: center;
      font-size: 18px;
      color: #555;
      padding: 40px 0;
    }

    .status-error {
      color: #c53030;
    }

    .goal-group-last {
      border-bottom: 3px solid #cbd5e0 !important;
    }

    /* 箭頭指標樣式 */
    .detail-table .desc-col.arrow-cell {
      padding: 0;
      vertical-align: middle;
      position: relative;
    }

    .arrow-indicator {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      width: 80%;
      height: 100%;
      padding: 12px 10px;
    }

    .arrow-indicator::before {
      content: '';
      flex: 1;
      height: 3px;
      background: linear-gradient(to right, #02a568 0%, #03c87e 100%);
      margin-right: 0;
    }

    .arrow-indicator::after {
      content: '▶';
      color: #02a568;
      font-size: 16px;
      font-weight: bold;
      line-height: 1;
      margin-left: -2px;
    }

    /* 複製按鈕樣式 */
    .desc-col {
      position: relative;
    }

    .copy-button {
      position: absolute;
      top: 4px;
      right: 4px;
      background-color: #4a7ba7;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px;
      width: 28px;
      height: 28px;
      font-size: 14px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s, background-color 0.2s;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .detail-table td:hover .copy-button {
      opacity: 1;
    }

    .copy-button:hover {
      background-color: #3a6b97;
    }

    .copy-button:active {
      background-color: #2c5282;
    }

    /* Toast 提示樣式 */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #48bb78;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1002; /* 高於剪貼簿的 1001 */
      animation: slideIn 0.3s ease-out, slideOut 0.3s ease-in 2.7s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    /* 底部工具列樣式 - 玻璃質感 */
    .floating-toolbar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.3);
      z-index: 999;
      transition: all 0.3s ease;
    }

    .floating-toolbar:hover {
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15), 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    /* 導航選單 */
    .nav-select {
      padding: 8px 16px;
      border: 1px solid rgba(141, 178, 85, 0.3);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      outline: none;
      transition: all 0.2s;
      min-width: 200px;
    }

    .nav-select:hover {
      border-color: #8db255;
      background: white;
    }

    .nav-select:focus {
      border-color: #8db255;
      box-shadow: 0 0 0 3px rgba(141, 178, 85, 0.1);
    }

    /* 剪貼簿按鈕 */
    .clipboard-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: linear-gradient(135deg, #02a568 0%, #03c078 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(2, 165, 104, 0.2);
    }

    .clipboard-btn:hover {
      background: linear-gradient(135deg, #019456 0%, #02a568 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(2, 165, 104, 0.3);
    }

    .clipboard-btn:active {
      transform: translateY(0);
    }

    .clipboard-btn .badge {
      background: rgba(255, 255, 255, 0.3);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .clipboard-btn svg {
      width: 18px;
      height: 18px;
      fill: white;
    }

    /* 剪貼簿 Modal - 從按鈕位置往上浮出 */
    .clipboard-modal {
      display: none;
      position: fixed;
      z-index: 1001;
    }

    .clipboard-modal.show {
      display: block;
    }

    .clipboard-content {
      position: fixed;
      /* 位置將由 JavaScript 動態設置 */
      background: white;
      border-radius: 16px;
      padding: 20px;
      width: 500px;
      max-width: calc(100vw - 40px);
      max-height: 60vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      animation: slideUpFromButton 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      transform: translate(-50%, -100%); /* 以中心點為基準，向上偏移 */
      margin-top: -20px; /* 距離按鈕的間距 */
    }

    @keyframes slideUpFromButton {
      from {
        transform: translate(-50%, calc(-100% + 20px)) scale(0.95);
        opacity: 0;
      }
      to {
        transform: translate(-50%, -100%) scale(1);
        opacity: 1;
      }
    }

    @keyframes slideDownToButton {
      from {
        transform: translate(-50%, -100%) scale(1);
        opacity: 1;
      }
      to {
        transform: translate(-50%, calc(-100% + 20px)) scale(0.95);
        opacity: 0;
      }
    }

    .clipboard-modal.closing .clipboard-content {
      animation: slideDownToButton 0.2s cubic-bezier(0.32, 0, 0.67, 0) forwards;
    }

    .clipboard-header {
      display: none; /* 隱藏標題區域 */
    }

    .clipboard-list {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      margin-bottom: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
    }
    
    .clipboard-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .clipboard-table thead {
      display: none; /* 隐藏表头 */
    }
    
    .clipboard-table th {
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      color: #495057;
      border-bottom: 2px solid #dee2e6;
      white-space: nowrap;
    }
    
    .clipboard-table th:first-child {
      width: 40px;
      text-align: center;
    }
    
    .clipboard-table td {
      padding: 12px 16px;
      border-bottom: 1px solid #e9ecef;
      color: #212529;
      line-height: 1.5;
      word-wrap: break-word;
      word-break: break-word;
    }
    
    .clipboard-table td:first-child {
      width: 40px;
      text-align: center;
      color: #6c757d;
      font-weight: 500;
      background: #f8f9fa;
    }
    
    .clipboard-table tbody tr {
      transition: background-color 0.15s ease;
      cursor: pointer;
    }
    
    .clipboard-table tbody tr:hover {
      background-color: #f1f9f5;
    }
    
    .clipboard-table tbody tr:active {
      background-color: #e6f4ed;
    }
    
    .clipboard-table tbody tr:last-child td {
      border-bottom: none;
    }

    .clipboard-empty {
      text-align: center;
      padding: 40px;
      color: #a0aec0;
      font-size: 16px;
    }

    .clipboard-empty-icon {
      font-size: 48px;
      margin-bottom: 12px;
    }

    .clipboard-actions {
      display: flex;
      gap: 8px;
    }

    .clipboard-action-btn {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .copy-all-btn {
      background: linear-gradient(135deg, #02a568 0%, #03c078 100%);
      color: white;
    }

    .copy-all-btn:hover {
      background: linear-gradient(135deg, #019456 0%, #02a568 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(2, 165, 104, 0.3);
    }

    .clear-btn {
      background: #e2e8f0;
      color: #4a5568;
    }

    .clear-btn:hover {
      background: #cbd5e0;
    }

    .clipboard-action-btn:active {
      transform: translateY(0);
    }

    .clipboard-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* 可點擊的課程目標樣式 */
    .clickable-goal {
      transition: all 0.2s ease;
      border-radius: 4px;
      padding: 2px 4px;
      margin: -2px -4px;
    }

    .clickable-goal:hover {
      background-color: rgba(59, 130, 246, 0.1);
      transform: scale(1.02);
    }

    .clickable-goal:active {
      background-color: rgba(59, 130, 246, 0.2);
      transform: scale(0.98);
    }

    /* 高亮動畫 */
    .highlight-goal {
      animation: highlightPulse 2s ease-out;
    }

    @keyframes highlightPulse {
      0% {
        background-color: rgba(59, 130, 246, 0.3);
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
      }
      50% {
        background-color: rgba(59, 130, 246, 0.2);
        box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
      }
      100% {
        background-color: transparent;
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
      }
    }
  </style>
</head>
<body>
  <main id="app">
    <div class="status-message">資料載入中</div>
  </main>

  <!-- 底部悬浮工具列 -->
  <div class="floating-toolbar">
    <select class="nav-select" id="domainNav">
      <option value="">選擇領域...</option>
    </select>
    <button class="clipboard-btn" id="clipboardBtn">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1s-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 16H5V5h2v3h10V5h2v14z"/>
      </svg>
      <span class="badge" id="clipboardCount">0</span>
    </button>
  </div>

  <!-- 剪貼簿 Modal -->
  <div class="clipboard-modal" id="clipboardModal">
    <div class="clipboard-content">
      <div class="clipboard-list" id="clipboardList">
        <div class="clipboard-empty">
          <div class="clipboard-empty-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 48px; height: 48px; fill: #cbd5e0;">
              <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1s-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 16H5V5h2v3h10V5h2v14z"/>
            </svg>
          </div>
          <div>尚未複製任何指標</div>
        </div>
      </div>
      <div class="clipboard-actions">
        <button class="clipboard-action-btn copy-all-btn" id="copyAllBtn" disabled>
          📄 全部複製
        </button>
        <button class="clipboard-action-btn clear-btn" id="clearBtn" disabled>
          🗑️ 清空
        </button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const DATA_URL = 'data/learning_indicators.json';
      const DETAIL_TITLE_TEXT = '各年齡層學習指標';
      const app = document.getElementById('app');
      
      // 剪貼簿歷史記錄
      let clipboardHistory = [];
      
      // 領域區塊參考
      let domainSections = [];

      init();

      async function init() {
        try {
          const data = await fetchData();
          clearApp();
          renderDomains(Array.isArray(data.domains) ? data.domains : []);
        } catch (error) {
          showStatus(`資料載入失敗：${error.message}`, true);
        }
      }

      function clearApp() {
        app.innerHTML = '';
      }

      function showStatus(message, isError = false) {
        clearApp();
        const status = document.createElement('div');
        status.className = 'status-message' + (isError ? ' status-error' : '');
        status.textContent = message;
        app.appendChild(status);
      }

      async function fetchData() {
        const response = await fetch(DATA_URL, { cache: 'no-store' });
        if (!response.ok) {
          throw new Error(`${response.status} ${response.statusText}`);
        }
        return response.json();
      }

      function renderDomains(domains) {
        if (!domains.length) {
          showStatus('尚未提供學習指標資料。', true);
          return;
        }

        domainSections = []; // 清空
        domains.forEach((domain) => {
          const domainElement = renderDomain(domain);
          app.appendChild(domainElement);
          domainSections.push({
            name: domain.title || domain.name || '未命名領域',
            element: domainElement
          });
        });
        
        // 初始化工具列
        initToolbar();
        
        // 初始化时检测当前位置
        updateCurrentDomain();
      }

      function renderDomain(domain) {
        const section = document.createElement('section');
        section.className = 'domain-section';

        const title = document.createElement('div');
        title.className = 'domain-title';
        title.textContent = domain.title || '';
        section.appendChild(title);

        const summary = domain.summary || null;
        const goalDescriptions = buildGoalDescriptionMap(summary);

        if (summary) {
          section.appendChild(renderSummaryTable(summary));
        }

        const detailTitle = document.createElement('div');
        detailTitle.className = 'detail-title';
        detailTitle.textContent = DETAIL_TITLE_TEXT;
        section.append(detailTitle);

        section.appendChild(renderDetailTable(domain.details || {}, goalDescriptions));

        return section;
      }

      function renderSummaryTable(summary) {
        const table = document.createElement('table');
        table.className = 'summary-table';

        const headers = Array.isArray(summary.headers) ? summary.headers : [];
        const rows = Array.isArray(summary.rows) ? summary.rows : [];

        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headers.forEach((header, index) => {
          const th = document.createElement('th');
          
          // 第一個表頭單元格使用對角線樣式
          if (index === 0) {
            th.className = 'diagonal-header';
            // 處理表頭文字，預期格式為 "學習面向\n領域能力" 或包含 <br>
            const headerText = header || '';
            // 分隔換行符或 <br> 標籤
            const lines = headerText
              .split(/\n|<br\s*\/?>/i)
              .map(line => line.trim())
              .filter(line => line);
            
            if (lines.length >= 2) {
              // 有兩行文字，使用對角線佈局
              // 第一行放右上角（學習面向）
              const topRight = document.createElement('span');
              topRight.className = 'top-right';
              topRight.textContent = lines[0];
              
              // 第二行放左下角（領域能力）
              const bottomLeft = document.createElement('span');
              bottomLeft.className = 'bottom-left';
              bottomLeft.textContent = lines[1];
              
              th.appendChild(topRight);
              th.appendChild(bottomLeft);
            } else {
              // 只有一行或沒有文字，直接顯示
              th.innerHTML = headerText;
            }
          } else {
            th.innerHTML = header || '';
          }
          
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        
        // 計算每個能力需要的 rowspan
        const abilityCounts = [];
        let currentAbility = null;
        let currentCount = 0;
        
        rows.forEach((row, index) => {
          const ability = row.ability || '';
          
          if (ability && ability !== currentAbility) {
            // 新的能力開始
            if (currentAbility !== null) {
              abilityCounts.push({ ability: currentAbility, count: currentCount, startIndex: index - currentCount });
            }
            currentAbility = ability;
            currentCount = 1;
          } else if (!ability && currentAbility) {
            // 空能力，屬於上一個能力的延續
            currentCount++;
          } else if (ability) {
            // 相同能力
            currentCount++;
          }
          
          // 最後一行
          if (index === rows.length - 1 && currentAbility !== null) {
            abilityCounts.push({ ability: currentAbility, count: currentCount, startIndex: index - currentCount + 1 });
          }
        });

        // 追蹤每個欄位被 rowspan 佔用的情況
        // rowspanTracker[colIndex] = 剩餘要跳過的行數
        const rowspanTracker = {};

        rows.forEach((row, rowIndex) => {
          const tr = document.createElement('tr');

          // 檢查這一行是否需要渲染能力單元格
          const abilityInfo = abilityCounts.find(info => info.startIndex === rowIndex);
          if (abilityInfo) {
            const abilityTd = document.createElement('td');
            abilityTd.className = 'ability-cell';
            abilityTd.textContent = abilityInfo.ability;
            if (abilityInfo.count > 1) {
              abilityTd.setAttribute('rowspan', abilityInfo.count);
            }
            tr.appendChild(abilityTd);
          } else if (!row.ability) {
            // 如果這行沒有能力且不是起始行，不添加能力單元格（被 rowspan 覆蓋）
          } else if (row.ability) {
            // 有能力但不是起始行，說明是新的能力組
            const abilityTd = document.createElement('td');
            abilityTd.className = 'ability-cell';
            abilityTd.textContent = row.ability;
            tr.appendChild(abilityTd);
          }

          // 計算實際需要渲染的欄位數（包括被 colspan 展開的）
          let totalColumns = headers.length - 1; // 減去能力欄
          let dataColIndex = 0; // JSON 中的欄位索引
          let renderColIndex = 0; // 實際要渲染的欄位位置（考慮被 rowspan 佔用的）
          
          while (renderColIndex < totalColumns && dataColIndex < (Array.isArray(row.cells) ? row.cells.length : 0)) {
            // 檢查這個欄位是否被上一行的 rowspan 佔用
            if (rowspanTracker[renderColIndex] && rowspanTracker[renderColIndex] > 0) {
              // 這個欄位被佔用，跳過渲染但要檢查 JSON 數據
              // JSON 中對應位置應該是空陣列
              rowspanTracker[renderColIndex]--;
              renderColIndex++;
              dataColIndex++; // 同時增加 dataColIndex，因為 JSON 中這個位置是空陣列
              continue;
            }
            
            // 渲染這個欄位
            const cellItems = Array.isArray(row.cells) && row.cells[dataColIndex] ? row.cells[dataColIndex] : [];
            const td = renderSummaryCell(cellItems);
            tr.appendChild(td);
            
            // 檢查是否有 rowspan，如果有就記錄
            if (cellItems[0] && cellItems[0].rowspan && cellItems[0].rowspan > 1) {
              const rowspanValue = cellItems[0].rowspan;
              // 記錄這個欄位在接下來的 (rowspan - 1) 行要被跳過
              rowspanTracker[renderColIndex] = rowspanValue - 1;
            }
            
            // 如果這個單元格有 colspan，跳過後續被佔據的欄位
            let colspanValue = 1;
            if (cellItems[0] && cellItems[0].colspan && cellItems[0].colspan > 1) {
              colspanValue = cellItems[0].colspan;
              renderColIndex += colspanValue;
            } else {
              renderColIndex++;
            }
            
            dataColIndex++;
          }

          tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        return table;
      }

      function renderSummaryCell(cellItems) {
        const td = document.createElement('td');

        if (!Array.isArray(cellItems) || !cellItems.length) {
          td.classList.add('empty-cell');
          return td;
        }

        // 檢查第一個項目是否有 colspan，如果有就設置到 td 上
        if (cellItems[0] && cellItems[0].colspan && cellItems[0].colspan > 1) {
          td.setAttribute('colspan', cellItems[0].colspan);
        }

        // 檢查第一個項目是否有 rowspan，如果有就設置到 td 上
        if (cellItems[0] && cellItems[0].rowspan && cellItems[0].rowspan > 1) {
          td.setAttribute('rowspan', cellItems[0].rowspan);
        }

        cellItems.forEach((item) => {
          const wrapper = document.createElement('div');
          wrapper.className = 'summary-cell-item';

          if (item.goal) {
            const goalDiv = document.createElement('div');
            goalDiv.className = 'goal-code';
            goalDiv.textContent = item.goal;
            wrapper.appendChild(goalDiv);
            
            // 添加可點擊樣式和點擊事件
            wrapper.classList.add('clickable-goal');
            wrapper.style.cursor = 'pointer';
            wrapper.addEventListener('click', () => {
              const targetElement = document.getElementById(`goal-${item.goal}`);
              if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // 添加高亮效果
                targetElement.classList.add('highlight-goal');
                setTimeout(() => {
                  targetElement.classList.remove('highlight-goal');
                }, 2000);
              }
            });
          }

          if (item.description) {
            const descDiv = document.createElement('div');
            descDiv.className = 'goal-desc';
            descDiv.textContent = item.description;
            wrapper.appendChild(descDiv);
          }

          td.appendChild(wrapper);
        });

        return td;
      }

      function buildGoalDescriptionMap(summary) {
        const map = {};

        if (!summary || !Array.isArray(summary.rows)) {
          return map;
        }

        summary.rows.forEach((row) => {
          if (!Array.isArray(row.cells)) {
            return;
          }

          row.cells.forEach((cell) => {
            if (!Array.isArray(cell)) {
              return;
            }

            cell.forEach((item) => {
              if (item && item.goal && !Object.prototype.hasOwnProperty.call(map, item.goal)) {
                map[item.goal] = item.description || '';
              }
            });
          });
        });

        return map;
      }

      function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M16.6667 5L7.5 14.1667L3.33333 10" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>${message}</span>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.remove();
        }, 3000);
      }

      function createCopyButton(textToCopy) {
        const button = document.createElement('button');
        button.className = 'copy-button';
        button.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M8 4V16C8 17.1046 8.89543 18 10 18H18C19.1046 18 20 17.1046 20 16V7.24162C20 6.7034 19.7831 6.18789 19.3982 5.81161L16.6569 3.11612C16.2698 2.73702 15.7484 2.52309 15.2045 2.52309H10C8.89543 2.52309 8 3.41852 8 4.52309V4Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M16 18V20C16 21.1046 15.1046 22 14 22H6C4.89543 22 4 21.1046 4 20V9C4 7.89543 4.89543 7 6 7H8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        `;
        button.title = '點擊複製';
        
        button.addEventListener('click', async (e) => {
          e.stopPropagation();
          try {
            await navigator.clipboard.writeText(textToCopy);
            
            // 添加到剪貼簿歷史記錄（避免重複）
            if (!clipboardHistory.includes(textToCopy)) {
              clipboardHistory.push(textToCopy);
              updateClipboardUI();
            }
            
            showToast('已複製到剪貼簿');
          } catch (err) {
            console.error('複製失敗:', err);
            showToast('複製失敗');
          }
        });
        
        return button;
      }

      function renderDetailTable(details, goalDescriptions = {}) {
        const table = document.createElement('table');
        table.className = 'detail-table';

        const ageHeaders = Array.isArray(details.ageHeaders) ? details.ageHeaders : [];
        const goals = Array.isArray(details.goals) ? details.goals : [];
        
        // 年齡對應代碼映射
        const ageToCode = {
          '2-3歲': '幼',
          '3-4歲': '小',
          '4-5歲': '中',
          '5-6歲': '大'
        };

        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');

        const goalTh = document.createElement('th');
        goalTh.style.width = '180px';
        goalTh.textContent = '課程目標';
        headerRow.appendChild(goalTh);

        ageHeaders.forEach((age) => {
          const th = document.createElement('th');
          th.className = 'age-header';
          th.textContent = age;
          headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');

        goals.forEach((goal) => {
          const indicators = Array.isArray(goal.indicators) ? goal.indicators : [];

          indicators.forEach((indicator, index) => {
            const tr = document.createElement('tr');
            
            if (index === indicators.length - 1) {
              tr.className = 'goal-group-last';
            }

            if (index === 0) {
              const goalTd = document.createElement('td');
              goalTd.className = 'goal-col';
              
              // 添加 ID 用於跳轉
              if (goal.goalId) {
                goalTd.id = `goal-${goal.goalId}`;
              }
              
              const goalCode = document.createElement('div');
              goalCode.className = 'goal-code';
              goalCode.textContent = goal.goalId || '';
              goalTd.appendChild(goalCode);

              const goalDescText = goal.goalId && Object.prototype.hasOwnProperty.call(goalDescriptions, goal.goalId)
                ? goalDescriptions[goal.goalId]
                : '';

              if (goalDescText) {
                const goalDesc = document.createElement('div');
                goalDesc.className = 'goal-desc';
                goalDesc.textContent = goalDescText;
                goalTd.appendChild(goalDesc);
              }

              if (indicators.length > 1) {
                goalTd.setAttribute('rowspan', indicators.length);
              }
              tr.appendChild(goalTd);
            }

            ageHeaders.forEach((age, ageIndex) => {
              const descTd = document.createElement('td');
              descTd.className = 'desc-col';
              
              const value = indicator.ages && Object.prototype.hasOwnProperty.call(indicator.ages, age)
                ? indicator.ages[age]
                : '';
              
              // 如果單元格為空，添加 empty-cell 類
              if (!value || value.trim() === '') {
                descTd.classList.add('empty-cell');
              }
              
              // 檢查是否為箭頭指標
              if (value === '⟶' || value.trim() === '⟶') {
                descTd.classList.add('arrow-cell');
                const arrowDiv = document.createElement('div');
                arrowDiv.className = 'arrow-indicator';
                descTd.appendChild(arrowDiv);
                
                // 為箭頭指標添加複製按鈕（複製延續前一個年齡段的內容）
                if (indicator.code && ageToCode[age]) {
                  const adjustedCode = indicator.code.replace(/[幼小中大](\/[幼小中大])*/, ageToCode[age]);
                  
                  // 尋找前一個年齡段的描述文字
                  let previousDesc = '';
                  for (let i = ageIndex - 1; i >= 0; i--) {
                    const prevAge = ageHeaders[i];
                    const prevValue = indicator.ages && Object.prototype.hasOwnProperty.call(indicator.ages, prevAge)
                      ? indicator.ages[prevAge]
                      : '';
                    // 找到第一個不是箭頭的內容
                    if (prevValue && prevValue !== '⟶' && prevValue.trim() !== '⟶') {
                      previousDesc = prevValue;
                      break;
                    }
                  }
                  
                  // 組合代碼和延續的描述
                  const copyText = previousDesc ? `${adjustedCode} ${previousDesc}` : adjustedCode;
                  const copyBtn = createCopyButton(copyText);
                  descTd.appendChild(copyBtn);
                }
              } else if (value) {
                // 只在有內容時顯示代碼和描述
                // 根據年齡替換代碼中的幼/小/中/大
                let adjustedCode = '';
                if (indicator.code && ageToCode[age]) {
                  const indicatorCode = document.createElement('div');
                  indicatorCode.className = 'indicator-code';
                  // 替換代碼中的 幼/小/中/大 部分
                  adjustedCode = indicator.code.replace(/[幼小中大](\/[幼小中大])*/, ageToCode[age]);
                  indicatorCode.textContent = adjustedCode;
                  descTd.appendChild(indicatorCode);
                }
                
                const desc = document.createElement('div');
                desc.className = 'indicator-desc';
                desc.textContent = value;
                descTd.appendChild(desc);
                
                // 添加複製按鈕（直接添加到 td，不是 wrapper）
                const copyText = adjustedCode ? `${adjustedCode}\n${value}` : value;
                const copyBtn = createCopyButton(copyText);
                descTd.appendChild(copyBtn);
              }

              tr.appendChild(descTd);
            });

            tbody.appendChild(tr);
          });
        });

        table.appendChild(tbody);
        return table;
      }

      // ============= 工具列功能 =============
      
      function initToolbar() {
        // 初始化導航選單
        populateNavSelect();
        setupScrollListener();
        
        // 設置剪貼簿按鈕事件
        document.getElementById('clipboardBtn').addEventListener('click', (e) => {
          openClipboardModal(e);
        });
        
        // 點擊 modal 外部關閉
        document.addEventListener('click', (e) => {
          const modal = document.getElementById('clipboardModal');
          const clipboardContent = document.querySelector('.clipboard-content');
          const clipboardBtn = document.querySelector('.clipboard-btn');
          
          if (modal.classList.contains('show') && 
              !clipboardContent.contains(e.target) && 
              !clipboardBtn.contains(e.target)) {
            closeClipboardModal();
          }
        });
        
        // 全部複製按鈕
        document.getElementById('copyAllBtn').addEventListener('click', async () => {
          if (clipboardHistory.length === 0) return;
          
          const allText = clipboardHistory.join('\n\n');
          try {
            await navigator.clipboard.writeText(allText);
            showToast(`已複製 ${clipboardHistory.length} 個指標`);
          } catch (err) {
            console.error('複製失敗:', err);
            showToast('複製失敗');
          }
        });
        
        // 清空按鈕
        document.getElementById('clearBtn').addEventListener('click', () => {
          if (confirm('確定要清空所有已複製的指標嗎？')) {
            clipboardHistory = [];
            updateClipboardUI();
            showToast('已清空剪貼簿');
          }
        });
        
        // 導航選單變更事件
        document.getElementById('domainNav').addEventListener('change', (e) => {
          const index = parseInt(e.target.value);
          if (!isNaN(index) && domainSections[index]) {
            domainSections[index].element.scrollIntoView({ 
              behavior: 'smooth',
              block: 'start'
            });
          }
        });
      }
      
      function populateNavSelect() {
        const select = document.getElementById('domainNav');
        select.innerHTML = '<option value="">選擇領域...</option>';
        
        domainSections.forEach((section, index) => {
          const option = document.createElement('option');
          option.value = index;
          option.textContent = section.name;
          select.appendChild(option);
        });
      }
      
      function setupScrollListener() {
        let lastScrollTop = 0;
        let ticking = false;
        
        window.addEventListener('scroll', () => {
          lastScrollTop = window.pageYOffset || document.documentElement.scrollTop;
          
          if (!ticking) {
            window.requestAnimationFrame(() => {
              updateNavSelect(lastScrollTop);
              ticking = false;
            });
            ticking = true;
          }
        });
      }
      
      function updateNavSelect(scrollTop) {
        const select = document.getElementById('domainNav');
        const offset = 100; // 偏移量，提前觸發
        
        for (let i = domainSections.length - 1; i >= 0; i--) {
          const section = domainSections[i];
          const rect = section.element.getBoundingClientRect();
          const elementTop = rect.top + scrollTop;
          
          if (scrollTop >= elementTop - offset) {
            if (select.value !== i.toString()) {
              select.value = i.toString();
            }
            break;
          }
        }
      }
      
      function updateCurrentDomain() {
        // 获取当前滚动位置
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        // 更新导航选单
        updateNavSelect(scrollTop);
      }
      
      function openClipboardModal(event) {
        const modal = document.getElementById('clipboardModal');
        const content = modal.querySelector('.clipboard-content');
        
        // 如果已經打開，則關閉
        if (modal.classList.contains('show')) {
          closeClipboardModal();
          return;
        }
        
        // 獲取按鈕的位置
        const button = event.currentTarget;
        const buttonRect = button.getBoundingClientRect();
        
        // 計算按鈕中心點
        const buttonCenterX = buttonRect.left + buttonRect.width / 2;
        const buttonTop = buttonRect.top;
        
        // 設置 modal 位置（以按鈕中心點為基準）
        content.style.left = `${buttonCenterX}px`;
        content.style.top = `${buttonTop}px`;
        
        modal.classList.add('show');
        updateClipboardList();
      }
      
      function closeClipboardModal() {
        const modal = document.getElementById('clipboardModal');
        
        // 添加 closing 類來觸發下浮動畫
        modal.classList.add('closing');
        
        // 等待動畫完成後移除 show 和 closing 類
        setTimeout(() => {
          modal.classList.remove('show', 'closing');
        }, 200); // 與動畫時間一致
      }
      
      function updateClipboardUI() {
        // 更新計數徽章
        document.getElementById('clipboardCount').textContent = clipboardHistory.length;
        
        // 更新按鈕狀態
        const hasItems = clipboardHistory.length > 0;
        document.getElementById('copyAllBtn').disabled = !hasItems;
        document.getElementById('clearBtn').disabled = !hasItems;
        
        // 更新剪貼簿列表顯示
        updateClipboardList();
      }
      
      function updateClipboardList() {
        const listContainer = document.getElementById('clipboardList');
        
        if (clipboardHistory.length === 0) {
          listContainer.innerHTML = `
            <div class="clipboard-empty">
              <div class="clipboard-empty-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 48px; height: 48px; fill: #cbd5e0;">
                  <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1s-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 16H5V5h2v3h10V5h2v14z"/>
                </svg>
              </div>
              <div>尚未複製任何指標</div>
            </div>
          `;
          return;
        }
        
        // 創建表格
        let tableHTML = `
          <table class="clipboard-table">
            <thead>
              <tr>
                <th>#</th>
                <th>學習指標內容</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        clipboardHistory.forEach((item, index) => {
          tableHTML += `
            <tr data-index="${index}" title="點擊複製此項">
              <td>${index + 1}</td>
              <td>${item}</td>
            </tr>
          `;
        });
        
        tableHTML += `
            </tbody>
          </table>
        `;
        
        listContainer.innerHTML = tableHTML;
        
        // 為每行添加點擊事件
        listContainer.querySelectorAll('tbody tr').forEach((row, index) => {
          row.addEventListener('click', async () => {
            const item = clipboardHistory[index];
            try {
              await navigator.clipboard.writeText(item);
              showToast('已複製');
            } catch (err) {
              console.error('複製失敗:', err);
              showToast('複製失敗');
            }
          });
        });
      }
    })();
  </script>
</body>
</html>
